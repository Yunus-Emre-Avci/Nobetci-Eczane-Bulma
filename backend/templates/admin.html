<!DOCTYPE html>
<html lang="tr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Eczane Bot Paneli</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        background-color: #f8f9fa;
        padding-top: 50px;
      }
      .log-box {
        background: #000;
        color: #0f0;
        font-family: monospace;
        padding: 15px;
        height: 300px;
        overflow-y: auto;
        border-radius: 5px;
        margin-top: 20px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="card shadow">
        <div class="card-header bg-primary text-white">
          <h4>ðŸ’Š NÃ¶betÃ§i Eczane GÃ¼ncelleme Paneli</h4>
        </div>
        <div class="card-body">
          <p class="card-text">
            Bu iÅŸlem mevcut veritabanÄ±ndaki
            <b>tÃ¼m nÃ¶betÃ§i eczaneleri silecek</b> ve il/ilÃ§e listesine gÃ¶re
            gÃ¼ncel verileri Ã§ekecektir.
          </p>

          <button
            id="startBtn"
            class="btn btn-danger btn-lg w-100"
            onclick="startScraping()"
          >
            ðŸš€ Verileri Ã‡ek ve GÃ¼ncelle
          </button>

          <div class="mt-4">
            <label>Ä°lerleme Durumu:</label>
            <div class="progress" style="height: 25px">
              <div
                id="progressBar"
                class="progress-bar progress-bar-striped progress-bar-animated bg-success"
                role="progressbar"
                style="width: 0%"
              >
                0%
              </div>
            </div>
          </div>

          <div class="log-box" id="logBox">> Sistem hazÄ±r bekliyor...</div>
        </div>
      </div>
    </div>

    <script>
      async function startScraping() {
        const btn = document.getElementById("startBtn");
        const logBox = document.getElementById("logBox");
        const progressBar = document.getElementById("progressBar");

        btn.disabled = true;
        btn.innerText = "Ä°ÅŸlem SÃ¼rÃ¼yor...";
        logBox.innerHTML = "> Ä°ÅŸlem baÅŸlatÄ±ldÄ±...\n";
        progressBar.style.width = "0%";
        progressBar.innerText = "0%";

        const response = await fetch("/admin/start-scrape");
        const reader = response.body.getReader();
        const decoder = new TextDecoder();

        while (true) {
          const { value, done } = await reader.read();
          if (done) break;

          const text = decoder.decode(value);
          const lines = text.split("\n");

          lines.forEach((line) => {
            if (line.trim() !== "") {
              // Format: PROGRESS|YÃ¼zde|Mesaj
              if (line.includes("PROGRESS|")) {
                const parts = line.split("|");
                const percent = parts[1];
                const message = parts[2];

                progressBar.style.width = percent + "%";
                progressBar.innerText = percent + "%";

                logBox.innerHTML += `> ${message}<br>`;
                logBox.scrollTop = logBox.scrollHeight;
              } else {
                logBox.innerHTML += `> ${line}<br>`;
              }
            }
          });
        }

        btn.disabled = false;
        btn.innerText = "ðŸš€ Verileri Ã‡ek ve GÃ¼ncelle";
        logBox.innerHTML += "> âœ… Ä°ÅžLEM TAMAMLANDI!<br>";
      }
    </script>
  </body>
</html>
